<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Logbook</title>
    <link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#00264d">
<link rel="apple-touch-icon" href="./icon-192.png">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Logbook">
    <style>
        /* [CSS ì „ì—­ ë³€ìˆ˜ ë° ê¸°ë³¸ í…Œë§ˆ ì„¤ì •] */
        :root { 
            --ap-navy: #00264d; --ap-gold: #c5a059; --bg: #f2f4f7; 
            --white: #ffffff; --accent: #e67e22; --danger: #e74c3c; 
            --google-green: #0f9d58; --google-blue: #4285f4;
        }

        /* [ê¸°ë³¸ ë ˆì´ì•„ì›ƒ ë° ë³¸ë¬¸ ìŠ¤íƒ€ì¼] */
        body { 
            font-family: 'Pretendard', 'Malgun Gothic', sans-serif; 
            background-color: var(--bg); margin: 0; display: flex; 
            flex-direction: column; height: 100vh; overflow: hidden; 
        }
        
        /* [ìƒë‹¨ í—¤ë” ë° íƒ­ ë©”ë‰´ ìŠ¤íƒ€ì¼] */
        .header { background: var(--ap-navy); color: white; padding: 10px 15px; flex-shrink: 0; }
        .tab-menu { display: flex; gap: 10px; margin-top: 10px; border-bottom: 1px solid rgba(255,255,255,0.2); flex-wrap: wrap;}
        .tab-btn { background: none; border: none; color: #aaa; padding: 8px 15px; cursor: pointer; font-weight: bold; font-size: 0.9rem; transition: 0.3s; }
        .tab-btn.active { color: var(--ap-gold); border-bottom: 3px solid var(--ap-gold); }

        /* [ì½˜í…ì¸  ì„¹ì…˜ ì œì–´] */
        .content-section { flex: 1; display: none; overflow: auto; flex-direction: column; }
        .content-section.active { display: flex; }

        /* [ìƒë‹¨ ëŒ€ì‹œë³´ë“œ ë° Recency ì¹´ë“œ ìŠ¤íƒ€ì¼] */
        .log-dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 8px; padding: 10px; background: #eaedf2; border-bottom: 1px solid #ccc; }
        .dash-card { background: white; padding: 8px; border-radius: 6px; text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-top: 3px solid var(--ap-navy); transition: 0.3s; }
        .dash-label { font-size: 0.65rem; color: #666; font-weight: bold; margin-bottom: 3px; }
        .dash-value { font-size: 0.9rem; font-weight: 800; color: var(--ap-navy); }
        .dash-recency { font-size: 0.9rem; color: var(--ap-navy); font-weight: bold; margin-top: 2px; }

        /* [í†µê³„ í•„í„° ì˜ì—­ ìŠ¤íƒ€ì¼] */
        .stat-filter-area { 
            padding: 10px 15px; display: flex; flex-wrap: nowrap; overflow-x: auto; 
            gap: 8px; background: white; border-bottom: 1px solid #ddd; align-items: center; 
        }

        /* [í†µê³„ ì¹´ë“œ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼] */
        .stats-container { padding: 20px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; align-content: start; }
        @media (min-width: 768px) { .stats-container { grid-template-columns: repeat(4, 1fr); } }

        .stat-card { 
            background: white; padding: 20px 10px; border-radius: 12px; text-align: center; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); border-top: 4px solid var(--ap-navy); border-left: none; 
            display: flex; flex-direction: column; justify-content: center; height: 100px; 
        }
        .stat-label { font-size: 0.8rem; color: #888; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; font-weight: 600; }
        .stat-value { font-size: 1.5rem; font-weight: 800; color: var(--ap-navy); line-height: 1.1; }
        .stat-sub { font-size: 0.8rem; color: #999; font-weight: normal; display: block; margin-top: 2px; }

        /* [ë¹„í–‰ ë¡œê·¸ ì…ë ¥ í•„ë“œ ìŠ¤íƒ€ì¼] */
        .input-section { background: var(--white); padding: 10px; border-bottom: 1px solid #ddd; display: flex; flex-wrap: wrap; gap: 8px; align-items: flex-end; flex-shrink: 0; }
        .field { display: flex; flex-direction: column; gap: 2px; }
        .field label { font-size: 0.7rem; font-weight: 800; color: #555; }
        input, select { padding: 5px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.8rem; height: 30px; box-sizing: border-box; }
        
        #date { width: 100px; } #reg { width: 70px; } #fm, #to { width: 40px; } #fltno { width: 80px; }
        #code { width: 60px; } #total, #sim { width: 60px; } 
        #remark { width: 180px; }

        /* [ë²„íŠ¼ ìŠ¤íƒ€ì¼] */
        .btn-area { display: flex; gap: 5px; margin-left: auto; align-items: center; }
        .btn-add { background: var(--ap-navy); color: white; border: none; padding: 0 12px; height: 30px; border-radius: 4px; font-weight: bold; cursor: pointer; }
        .btn-update { background: var(--accent); color: white; border: none; padding: 0 12px; height: 30px; border-radius: 4px; font-weight: bold; cursor: pointer; display: none; }
        .btn-export { background: var(--ap-gold); color: white; border: none; padding: 0 10px; height: 30px; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 0.75rem; }
        .btn-import { background: #27ae60; color: white; border: none; padding: 0 10px; height: 30px; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 0.75rem; }
        .btn-reset { background: var(--danger); color: white; border: none; padding: 0 10px; height: 30px; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 0.75rem; }
        
        /* [êµ¬ê¸€ ì—°ë™ ë²„íŠ¼ ìŠ¤íƒ€ì¼] */
        .btn-google-save { background: var(--google-green); color: white; border: none; padding: 0 10px; height: 30px; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 0.75rem; display: flex; align-items: center; gap: 4px; }
        .btn-google-load { background: var(--google-blue); color: white; border: none; padding: 0 10px; height: 30px; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 0.75rem; display: flex; align-items: center; gap: 4px; }
        .spinner { border: 2px solid rgba(255,255,255,0.3); border-top: 2px solid white; border-radius: 50%; width: 12px; height: 12px; animation: spin 1s linear infinite; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* [ë¡œê·¸ ë¦¬ìŠ¤íŠ¸ ë° í…Œì´ë¸” ìŠ¤íƒ€ì¼] */
        .list-section { flex: 1; overflow: auto; background: #eee; }
        
        table { 
            width: 100%; 
            border-collapse: collapse; 
            background: white; 
            white-space: nowrap; 
        }

        th { 
            background: #f8f9fa; position: sticky; top: 0; padding: 10px 5px; 
            font-size: 0.65rem; border-bottom: 2px solid #bbb; z-index: 10; 
            color: #333; box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
        }

        td { 
            padding: 8px 4px; border-bottom: 1px solid #eee; 
            border-right: 1px solid #eee; text-align: center; font-size: 0.75rem; color: #444; 
        }

        td:nth-child(1), th:nth-child(1),
        td:nth-child(3), th:nth-child(3),
        td:nth-child(6), th:nth-child(6),
        td:nth-child(7), th:nth-child(7),
        td:nth-child(11), th:nth-child(11),
        td:nth-child(13), th:nth-child(13),
        td:nth-child(14), th:nth-child(14) { border-right: 2px solid #ccc; }

        tbody tr:nth-child(even) { background-color: #f2f0f0; }
        tbody tr:hover { background-color: #e3f2fd; transition: background-color 0.1s; }

        .row-total { font-weight: bold; color: var(--accent); }
        .btn-edit { background: #54a0ff; color: white; border: none; width: 22px; height: 22px; border-radius: 3px; cursor: pointer; margin-right: 2px; font-size: 0.75rem; padding: 0; }
        .btn-del { background: #ff7675; color: white; border: none; width: 22px; height: 22px; border-radius: 3px; cursor: pointer; font-size: 0.75rem; padding: 0; }
        
        .val-zero { color: #d1d5db; font-weight: 400; } 
        .val-active { color: var(--ap-navy); font-weight: 800; } 
        .text-bold { font-weight: 900; color: var(--ap-navy); }
        
        /* [ë°ì´í„° ê´€ë¦¬ íƒ­] */
        .data-management { padding: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .data-card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .data-card h4 { margin-top: 0; color: var(--ap-navy); border-bottom: 2px solid var(--ap-navy); padding-bottom: 5px; }
        .data-form { display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 8px; margin-bottom: 15px; align-items: flex-end; }
        
        @media (max-width: 1000px) { 
            .input-section { overflow-x: auto; flex-wrap: nowrap; padding-bottom: 12px; } 
            .data-management { grid-template-columns: 1fr; }
        }

        /* [ëª¨ë‹¬ ê³µí†µ ìŠ¤íƒ€ì¼ ë° ë‹¤ì´ì–¼ UI] */
        .custom-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1000;
            display: flex; justify-content: center; align-items: center;
        }
        .custom-modal-content {
            background: white; border-radius: 12px; width: 90%; max-width: 340px;
            max-height: 80vh; 
            display: flex; flex-direction: column; overflow: hidden;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }
        .custom-modal-header {
            margin: 0; background: var(--ap-navy); color: white; padding: 15px;
            font-size: 1.1rem; text-align: center; font-weight: 800; flex-shrink: 0;
        }
        .custom-modal-body {
            padding: 20px; overflow-y: auto; text-align: center; color: #444; flex: 1;
            font-size: 0.95rem; line-height: 1.5;
        }
        .custom-modal-footer {
            padding: 15px; display: flex; gap: 10px; justify-content: center;
            background: #f8f9fa; border-top: 1px solid #ddd; flex-shrink: 0;
        }
        .btn-modal-ok {
            background: var(--ap-navy); color: white; border: none; padding: 12px 20px;
            border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 0.95rem; flex: 1; transition: 0.2s;
        }
        .btn-modal-cancel {
            background: #ddd; color: #333; border: none; padding: 12px 20px;
            border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 0.95rem; flex: 1; transition: 0.2s;
        }

        .dial-label { font-size: 1rem; font-weight: 900; color: var(--ap-navy); }
        .dial-container {
            display: flex; justify-content: center; align-items: center; gap: 15px;
            height: 280px; position: relative; background: #fff;
            border: 1px solid #ddd; border-radius: 8px;
        }
        .dial-selection {
            position: absolute; top: 50%; left: 10px; right: 10px; height: 40px; margin-top: -20px;
            background: rgba(0, 38, 77, 0.08); border-top: 2px solid var(--ap-navy); border-bottom: 2px solid var(--ap-navy);
            pointer-events: none; border-radius: 4px;
        }
        .dial-wheel {
            height: 280px; overflow-y: scroll; scroll-snap-type: y mandatory;
            scrollbar-width: none; -ms-overflow-style: none; scroll-behavior: smooth;
        }
        .dial-wheel::-webkit-scrollbar { display: none; }
        .dial-item {
            height: 40px; line-height: 40px; font-size: 1rem; font-weight: 800; color: #333;
            scroll-snap-align: center; text-align: center; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .dial-spacer { height: 120px; } 
        .dial-separator { font-size: 1.5rem; font-weight: 900; color: var(--ap-navy); }
        
        #floatingViewBtn {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            z-index: 900; display: none;
        }
        #floatingViewBtn button {
            background: var(--ap-navy); color: white; border: none; padding: 12px 24px;
            border-radius: 30px; cursor: pointer; font-weight: 900; font-size: 1rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); transition: transform 0.2s; white-space: nowrap;
        }
        #floatingViewBtn button:active { transform: scale(0.95); }
    </style>
</head>
<body>
    <div class="header">
        <h3 style="margin:0; text-align: center; font-size:1.5rem;">Swlee's PILOT LOGBOOK</h3>
        <div class="tab-menu">
            <button class="tab-btn active" onclick="showTab('logTab', this)">Flight Log</button>
            <button class="tab-btn" onclick="showTab('statTab', this)">Stats</button>
            <button class="tab-btn" onclick="showTab('dataTab', this)">DATA</button>
            <div class="btn-area">
                <button class="btn-google-save" onclick="saveToGoogleSheet()" id="btnGSave">
                    <span class="spinner" id="spinSave"></span> ğŸ“¤ Save
                </button>
                <button class="btn-google-load" onclick="loadFromGoogleSheet()" id="btnGLoad">
                    <span class="spinner" id="spinLoad"></span> ğŸ“¥ Load
                </button>
                <button class="btn-export" onclick="exportCSV()">EXPORT</button>
                <button class="btn-import" onclick="document.getElementById('fileInput').click()">IMPORT</button>
                <button class="btn-reset" onclick="resetAllData()">RESET</button>
                <input type="file" id="fileInput" hidden accept=".csv" onchange="importCSV(this)">
            </div>
        </div>
    </div>

    <div id="logTab" class="content-section active">
        <div class="input-section">
            <input type="hidden" id="editId">
            <div class="field"><label>Date</label><input type="date" id="date"></div>
            <div class="field" style="display:none;"><label>TYPE</label><input type="hidden" id="type" value="B789"></div>
            
            <div class="field">
                <label>REG</label>
                <input type="text" id="reg" readonly onclick="openDial('reg')" placeholder="ì„ íƒ" style="cursor: pointer; background-color: #f1f3f5; text-align: center; font-weight: bold;">
            </div>
            <div class="field">
                <label>FLT NO</label>
                <input type="text" id="fltno" readonly onclick="openDial('fltno')" placeholder="ì„ íƒ" style="cursor: pointer; background-color: #f1f3f5; text-align: center; font-weight: bold;">
            </div>
            
            <div class="field">
                <label>FM</label>
                <input type="text" id="fm" placeholder="ì¶œë°œ" readonly style="width: 40px; background-color: #eee;">
            </div>
            <div class="field">
                <label>TO</label>
                <input type="text" id="to" placeholder="ë„ì°©" readonly style="width: 40px; background-color: #eee;">
            </div>
            
            <div class="field">
                <label>Code</label>
                <input type="text" id="code" readonly onclick="openDial('code')" placeholder="ì„ íƒ" style="cursor: pointer; background-color: #f1f3f5; text-align: center; font-weight: bold;">
            </div>
            
            <div class="field"><label>BLOCK</label><input type="text" id="total" placeholder="0+00" readonly onclick="openTimeModal(this)" style="cursor: pointer; background-color: #f1f3f5; text-align: center; font-weight: bold;"></div>
            <div class="field"><label>SIM</label><input type="text" id="sim" placeholder="0+00" readonly onclick="openTimeModal(this)" style="cursor: pointer; background-color: #f1f3f5; text-align: center; font-weight: bold;"></div>
            
            <div class="field">
                <label>TO & LD</label>
                <input type="text" id="toldDisplay" readonly onclick="openToldModal()" placeholder="No / No" style="cursor: pointer; background-color: #f1f3f5; text-align: center; font-weight: bold; width: 110px;">
            </div>
            
            <input type="hidden" id="dto" value="0">
            <input type="hidden" id="nto" value="0">
            <input type="hidden" id="dld" value="0">
            <input type="hidden" id="nld" value="0">
            
            <div class="field"><label>Remarks</label><input type="text" id="remark"></div>
            <div class="btn-area">
                <button id="btnAdd" class="btn-add" onclick="addLog()">ADD</button>
                <button id="btnUpdate" class="btn-update" onclick="updateLog()">UPDATE</button>
                <button id="btnCancel" class="btn-del" onclick="resetForm()" style="display: none; height: 30px; width: auto; padding: 0 12px;">CANCEL</button>
            </div>
        </div>

        <div class="log-dashboard">
            <div class="dash-card" id="cardRecTO"><div class="dash-label">RECENCY (TO)</div><div class="dash-recency" id="dashRecTO">-</div></div>
            <div class="dash-card" id="cardRecLD"><div class="dash-label">RECENCY (LD)</div><div class="dash-recency" id="dashRecLD">-</div></div>
            <div class="dash-card"><div class="dash-label">28 DAYS</div><div class="dash-value" id="dash28">00+00</div></div>
            <div class="dash-card"><div class="dash-label">90 DAYS</div><div class="dash-value" id="dash90">00+00</div></div>
            <div class="dash-card"><div class="dash-label">365 DAYS</div><div class="dash-value" id="dash365">00+00</div></div>
        </div>

        <div class="list-section">
            <table>
                <thead>
                    <tr>
                        <th>DATE</th><th>TYPE</th><th>REG</th><th>FM</th><th>TO</th><th>FLT NO</th>
                        <th>BLOCK</th><th>IP</th><th>CAPT</th><th>F/O</th><th>SIM</th>
                        <th>D.T/L</th><th>N.T/L</th><th>REMARKS</th><th>Management</th>
                    </tr>
                </thead>
                <tbody id="logBody"></tbody>
            </table>
        </div>
        <div id="floatingViewBtn"></div>
    </div>

    <div id="statTab" class="content-section">
        <div class="stat-filter-area" style="justify-content: center; padding: 15px;">
            <button onclick="openStatsFilterModal()" style="width:100%; max-width: 400px; height: 40px; background: var(--ap-navy); color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 1rem; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; gap: 8px;">
                <span style="font-size: 1.2rem;">ğŸ”</span> í†µê³„ í•„í„° ì„¤ì •
            </button>
        </div>

        <div class="stats-container">
            <div class="stat-card"><div class="stat-label">BLOCK TIME</div><div class="stat-value" id="statTime">00+00</div></div>
            <div class="stat-card" style="border-left-color: var(--accent);">
                <div class="stat-label">PIC TIME <br>(IP+CAPT)</div>
                <div class="stat-value"><span id="statPIC">00+00</span> <span class="stat-sub" id="statIPSub">(00+00)</span></div>
            </div>
            <div class="stat-card"><div class="stat-label">F/O TIME</div><div class="stat-value" id="statFO">00+00</div></div>
            <div class="stat-card"><div class="stat-label">SIM TIME</div><div class="stat-value" id="statSimTotal">00+00</div></div>
            <div class="stat-card"><div class="stat-label">TOTAL FLIGHTS</div><div class="stat-value" id="statFlt">0</div></div>            <div class="stat-card" style="border-top-color: var(--accent);">
                <div class="stat-label">TO Total(Nt) <br> LD Total(Nt)</div>
                <div class="stat-value" id="statToLdCombined" style="font-size: 1.1rem;">0(0) / 0(0)</div>
            </div>
        </div>
    </div>

    <div id="dataTab" class="content-section">
        <div class="data-management">
            <div class="data-card" style="grid-column: 1 / -1;">
                <h4>Google Sheet URL ì„¤ì •</h4>
                <div class="data-form">
                    <div class="field" style="flex: 1;"><label>Script URL</label><input type="text" id="googleUrlInput" placeholder="https://script.google.com/macros/s/.../exec"></div>
                    <button class="btn-add" onclick="saveGoogleUrl()">ì €ì¥</button>
                </div>
                <p style="margin: 5px 0 0 0; font-size: 0.75rem; color: #666;">* URLì€ ì´ ê¸°ê¸°ì˜ ë¸Œë¼ìš°ì €ì—ë§Œ ì•ˆì „í•˜ê²Œ ë³´ê´€ë©ë‹ˆë‹¤.</p>
            </div>
            
            <div class="data-card">
                <h4>FLT NO DATA</h4>
                <div class="data-form">
                    <div class="field"><label>FLT NO</label><input type="text" id="newDataFlt" placeholder="YP"></div>
                    <div class="field"><label>FM</label><input type="text" id="newDataFm" placeholder="FM"></div>
                    <div class="field"><label>TO</label><input type="text" id="newDataTo" placeholder="TO"></div>
                    <button class="btn-add" onclick="saveRouteData()">ì €ì¥</button>
                </div>
                <table>
                    <thead><tr><th>FLT NO</th><th>FM</th><th>TO</th><th>ì‚­ì œ</th></tr></thead>
                    <tbody id="routeDataBody"></tbody>
                </table>
            </div>

            <div class="data-card">
                <h4>Code DATA</h4>
                <div class="data-form">
                    <div class="field"><label>Code</label><input type="text" id="newCodeName" placeholder="ì˜ˆ: 2C1"></div>
                    <div class="field"><label>IP ë¹„ìœ¨</label>
                        <select id="rateIP">
                            <option value="1">1</option><option value="0.666">2/3</option><option value="0.5">1/2</option><option value="0.333">1/3</option><option value="0.4">2/5</option><option value="0" selected>0</option>
                        </select>
                    </div>
                    <div class="field"><label>CAPT ë¹„ìœ¨</label>
                        <select id="rateCapt">
                            <option value="1" selected>1</option><option value="0.666">2/3</option><option value="0.5">1/2</option><option value="0.333">1/3</option><option value="0.4">2/5</option><option value="0">0</option>
                        </select>
                    </div>
                    <div class="field"><label>FO ë¹„ìœ¨</label>
                        <select id="rateFO">
                            <option value="1">1</option><option value="0.666">2/3</option><option value="0.5">1/2</option><option value="0.333">1/3</option><option value="0.4">2/5</option><option value="0" selected>0</option>
                        </select>
                    </div>
                    <button class="btn-add" onclick="saveCodeData()">ì €ì¥</button>
                </div>
                <table><thead><tr><th>Code</th><th>IP</th><th>CAPT</th><th>FO</th><th>ì‚­ì œ</th></tr></thead><tbody id="codeDataBody"></tbody></table>
            </div>
        </div>
    </div>

    <div id="modalOverlay" class="custom-modal-overlay" style="display: none;">
        <div class="custom-modal-content">
            <h4 id="modalTitle" class="custom-modal-header">ì•Œë¦¼</h4>
            <div class="custom-modal-body" id="modalMsg"></div>
            <div class="custom-modal-footer">
                <button onclick="closeModal(true)" class="btn-modal-ok">í™•ì¸</button>
                <button id="modalCancelBtn" onclick="closeModal(false)" class="btn-modal-cancel">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <div id="statsFilterModalOverlay" class="custom-modal-overlay" style="display: none;">
        <div class="custom-modal-content" style="max-width: 320px;">
            <h4 class="custom-modal-header">í†µê³„ í•„í„° ì„¤ì •</h4>
            <div class="custom-modal-body" style="padding: 20px; text-align: left; display: grid; gap: 12px;">
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div class="field"><label>ì‹œì‘ì¼</label><input type="date" id="startDateFilter" style="width: 100%;"></div>
                    <div class="field"><label>ì¢…ë£Œì¼</label><input type="date" id="endDateFilter" style="width: 100%;"></div>
                </div>

                <div class="field">
                    <label>ê¸°ì¢… (TYPE)</label>
                    <input type="text" id="typeFilter" readonly onclick="openDial('typeFilter')" placeholder="ALL" value="ALL" style="cursor: pointer; background-color: #f1f3f5; text-align: center; font-weight: bold; width: 100%;">
                </div>
                
                <div class="field">
                    <label>í•­ê³µì‚¬ (Airlines)</label>
                    <input type="text" id="companyFilter" readonly onclick="openDial('companyFilter')" placeholder="ALL" value="ALL" style="cursor: pointer; background-color: #f1f3f5; text-align: center; font-weight: bold; width: 100%;">
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div class="field">
                        <label>ì¶œë°œ (FM)</label>
                        <input type="text" id="fromFilter" readonly onclick="openDial('fromFilter')" placeholder="ALL" value="ALL" style="cursor: pointer; background-color: #f1f3f5; text-align: center; font-weight: bold; width: 100%;">
                    </div>
                    <div class="field">
                        <label>ë„ì°© (TO)</label>
                        <input type="text" id="toFilter" readonly onclick="openDial('toFilter')" placeholder="ALL" value="ALL" style="cursor: pointer; background-color: #f1f3f5; text-align: center; font-weight: bold; width: 100%;">
                    </div>
                </div>

            </div>
            <div class="custom-modal-footer" style="padding: 10px;">
                <button onclick="applyStatsFilters()" class="btn-modal-ok">ì ìš©</button>
                <button onclick="resetStatsFilters()" class="btn-modal-cancel" style="background:var(--danger); color:white; border:none; padding:12px 10px; border-radius:6px; font-weight:bold; cursor:pointer;">ì´ˆê¸°í™”</button>
                <button onclick="closeStatsFilterModal()" class="btn-modal-cancel">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <div id="timeModalOverlay" class="custom-modal-overlay" style="display: none; z-index: 1010;">
        <div class="custom-modal-content">
            <h4 class="custom-modal-header" id="timeModalHeader">ë¹„í–‰ ì‹œê°„ ì…ë ¥</h4>
            <div class="custom-modal-body" style="padding: 15px;">
                <p style="margin:0 0 10px 0; font-size:0.8rem; color:#666; font-weight:bold;">ë‹¤ì´ì–¼ì„ ìœ„ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤í•˜ì„¸ìš”.</p>
                
                <div style="display:flex; justify-content:center; gap: 70px; margin-bottom: 5px;">
                    <p class="dial-label" style="margin:0;">ì‹œê°„ (HH)</p>
                    <p class="dial-label" style="margin:0;">ë¶„ (MM)</p>
                </div>
                
                <div class="dial-container">
                    <div class="dial-selection"></div>
                    <div id="dialHour" class="dial-wheel" style="width: 60px;"></div>
                    <span class="dial-separator">+</span>
                    <div id="dialMinute" class="dial-wheel" style="width: 60px;"></div>
                </div>
            </div>
            <div class="custom-modal-footer">
                <button onclick="confirmTime()" class="btn-modal-ok">ì…ë ¥</button>
                <button onclick="closeTimeModal()" class="btn-modal-cancel">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <div id="genericDialModalOverlay" class="custom-modal-overlay" style="display: none; z-index: 1010;">
        <div class="custom-modal-content">
            <h4 class="custom-modal-header" id="genericDialHeader">ì„ íƒ</h4>
            <div class="custom-modal-body" style="padding: 15px;">
                <p style="margin:0 0 5px 0; font-size:0.8rem; color:#666; font-weight:bold;">ë‹¤ì´ì–¼ì„ ìœ„ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤í•˜ì„¸ìš”.</p>
                <div id="genericDialInfo" style="margin-bottom: 10px; font-size: 1.1rem; font-weight: 900; color: var(--accent); min-height: 1.5rem; display: flex; align-items: center; justify-content: center;"></div>
                
                <div class="dial-container">
                    <div class="dial-selection"></div>
                    <div id="genericDialWheel" class="dial-wheel" style="width: 150px;" onscroll="handleGenericDialScroll()"></div>
                </div>
            </div>
            <div class="custom-modal-footer">
                <button onclick="confirmGenericDial()" class="btn-modal-ok">ì…ë ¥</button>
                <button onclick="closeGenericDial()" class="btn-modal-cancel">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <div id="toldModalOverlay" class="custom-modal-overlay" style="display: none; z-index: 1010;">
        <div class="custom-modal-content">
            <h4 class="custom-modal-header">ì´ì°©ë¥™(T/O & LDG) ì„ íƒ</h4>
            <div class="custom-modal-body" style="padding: 15px;">
                <p style="margin:0 0 10px 0; font-size:0.8rem; color:#666; font-weight:bold;">ë‹¤ì´ì–¼ì„ ìœ„ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤í•˜ì„¸ìš”.</p>
                
                <div style="display:flex; justify-content:center; gap: 40px; margin-bottom: 5px;">
                    <p class="dial-label" style="margin:0; font-size: 1.1rem;">ì´ë¥™ (T/O)</p>
                    <p class="dial-label" style="margin:0; font-size: 1.1rem;">ì°©ë¥™ (LDG)</p>
                </div>
                
                <div class="dial-container">
                    <div class="dial-selection"></div>
                    <div id="dialTkof" class="dial-wheel" style="width: 120px;"></div>
                    <span class="dial-separator">/</span>
                    <div id="dialLand" class="dial-wheel" style="width: 120px;"></div>
                </div>
            </div>
            <div class="custom-modal-footer">
                <button onclick="confirmToldDial()" class="btn-modal-ok">ì…ë ¥</button>
                <button onclick="closeToldModal()" class="btn-modal-cancel">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

<script>
        let GOOGLE_SCRIPT_URL = ""; 
        const URL_KEY = 'pilot_google_url';
        
        const STORAGE_KEY = 'pilot_log_v_tablet';
        const ROUTE_KEY = 'pilot_routes_v1';
        const CODE_KEY = 'pilot_codes_v1';

        let logs = [];
        let routes = [];
        let codeRules = [];

        function saveGoogleUrl() {
            const url = document.getElementById('googleUrlInput').value.trim();
            if (!url) { alert("URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
            GOOGLE_SCRIPT_URL = url;
            localStorage.setItem(URL_KEY, url);
            alert("âœ… Google Sheet URLì´ ê¸°ê¸°ì— ì•ˆì „í•˜ê²Œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }

        function init() {
            document.getElementById('date').valueAsDate = new Date();
            
            try {
                const savedUrl = localStorage.getItem(URL_KEY);
                if (savedUrl) {
                    GOOGLE_SCRIPT_URL = savedUrl;
                    document.getElementById('googleUrlInput').value = savedUrl;
                }
            } catch (e) { }

            try {
                const savedLogs = localStorage.getItem(STORAGE_KEY);
                logs = savedLogs ? JSON.parse(savedLogs) : [];
                if (!Array.isArray(logs)) logs = [];
            } catch (e) { logs = []; }

            try {
                const savedRoutes = localStorage.getItem(ROUTE_KEY);
                routes = savedRoutes ? JSON.parse(savedRoutes) : [];
                if (!Array.isArray(routes)) routes = [];
                if(routes.length === 0) routes = [{"fltno":"YP131","fm":"ICN","to":"LAX"}];
            } catch (e) { routes = []; }

            try {
                const savedCodes = localStorage.getItem(CODE_KEY);
                codeRules = savedCodes ? JSON.parse(savedCodes) : [];
                if (!Array.isArray(codeRules)) codeRules = [];
                if(codeRules.length === 0) codeRules = [{"name":"2C1","ip":0,"capt":1,"fo":0}];
            } catch (e) { codeRules = []; }

            render(); 
            renderRouteTable();
            renderCodeTable();
            initDialPicker(); 
        }

        // ==========================================
        // ìˆ˜ë™ ë™ê¸°í™” ë¡œì§ (Load & Save)
        // ==========================================
        
        function loadFromGoogleSheet() {
            if (!GOOGLE_SCRIPT_URL) { alert("DATA íƒ­ì—ì„œ Google Sheet URLì„ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”."); return; }

            const btn = document.getElementById('btnGLoad');
            const spinner = document.getElementById('spinLoad');
            btn.disabled = true; spinner.style.display = 'inline-block';

            // ê¸°ê¸° ë°ì´í„°ë¥¼ ë®ì–´ì“°ê¸° ì „ì—, êµ¬ê¸€ ì‹œíŠ¸ ë°ì´í„°ë¥¼ ë¨¼ì € ë°›ì•„ì˜µë‹ˆë‹¤.
            fetch(GOOGLE_SCRIPT_URL) 
            .then(response => response.json())
            .then(data => {
                if (data.error) { alert("ì„œë²„ ë©”ì‹œì§€: " + data.error); return; }

                const cloudLogs = data.logs || [];
                let latestInfo = "ì €ì¥ëœ ë¹„í–‰ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.";
                
                // ë°›ì•„ì˜¨ ë°ì´í„° ì¤‘ ê°€ì¥ ìµœê·¼ ë‚ ì§œì˜ ë¡œê·¸ë¥¼ ì°¾ìŠµë‹ˆë‹¤.
                if (cloudLogs.length > 0) {
                    let latestLog = cloudLogs.reduce((latest, current) => {
                        return new Date(current.date) > new Date(latest.date) ? current : latest;
                    }, cloudLogs[0]);
                    
                    latestInfo = `<div style="background:#f1f3f5; padding:10px; border-radius:6px; margin:10px 0; color:#333;">
                                    <b style="color:var(--ap-navy);">[í´ë¼ìš°ë“œ ë§ˆì§€ë§‰ ë¹„í–‰ ê¸°ë¡]</b><br>
                                    ğŸ“… ë‚ ì§œ: <b>${latestLog.date}</b><br>
                                    âœˆï¸ í¸ëª…: <b>${latestLog.fltno}</b> (${latestLog.fm} â” ${latestLog.to})
                                  </div>`;
                }

                const msg = `êµ¬ê¸€ ì‹œíŠ¸ì˜ ìµœì‹  ë°ì´í„°ë¥¼ í˜„ì¬ ê¸°ê¸°ë¡œ ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?<br>
                             ${latestInfo}
                             <span style='color:red; font-size:0.85em; font-weight:bold;'>(âš ï¸ì£¼ì˜: í˜„ì¬ ê¸°ê¸°ì˜ ëª¨ë“  ë°ì´í„°ê°€ ì§€ì›Œì§€ê³  ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤!)</span>`;

                showModal("ğŸ“¥ ì „ì²´ ë¶ˆëŸ¬ì˜¤ê¸° í™•ì¸", msg, (ok) => {
                    if (!ok) return;
                    
                    // ì‚¬ìš©ìê°€ í™•ì¸ì„ ëˆ„ë¥´ë©´ ë°ì´í„°ë¥¼ êµì²´í•˜ê³  ì €ì¥í•©ë‹ˆë‹¤.
                    logs = cloudLogs;
                    routes = data.routes || [];
                    codeRules = data.codeRules || [];
                    
                    saveData();
                    localStorage.setItem(ROUTE_KEY, JSON.stringify(routes));
                    localStorage.setItem(CODE_KEY, JSON.stringify(codeRules));

                    render();   
                    renderRouteTable();
                    renderCodeTable();
                    
                    alert(`âœ… ë™ê¸°í™” ì™„ë£Œ!\n- ë¡œê·¸: ${logs.length}ê±´\n- ë…¸ì„ : ${routes.length}ê°œ\n- ì½”ë“œ: ${codeRules.length}ê°œ`);
                }, true, true);
            })
            .catch(error => {
                alert("ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: " + error);
            })
            .finally(() => {
                btn.disabled = false; spinner.style.display = 'none';
            });
        }

        function saveToGoogleSheet() {
            if (!GOOGLE_SCRIPT_URL) { alert("DATA íƒ­ì—ì„œ Google Sheet URLì„ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”."); return; }
            
            showModal("ğŸ“¤ ì „ì²´ ì €ì¥í•˜ê¸°", "í˜„ì¬ ê¸°ê¸°ì˜ ì „ì²´ ê¸°ë¡ì„ êµ¬ê¸€ ì‹œíŠ¸ì— ë°±ì—…(ë®ì–´ì“°ê¸°) í•˜ì‹œê² ìŠµë‹ˆê¹Œ?", (ok) => {
                if (!ok) return;

                const payload = {
                    action: "SYNC_ALL", 
                    logs: logs,
                    routes: routes,
                    codeRules: codeRules
                };

                const btn = document.getElementById('btnGSave');
                const spinner = document.getElementById('spinSave');
                btn.disabled = true; spinner.style.display = 'inline-block';
                
                fetch(GOOGLE_SCRIPT_URL, {
                    method: "POST",
                    mode: "no-cors",
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                    body: JSON.stringify(payload)
                })
                .then(() => { 
                    alert("âœ… ì„±ê³µì ìœ¼ë¡œ í´ë¼ìš°ë“œì— ì „ì²´ ë°ì´í„°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                })
                .catch(e => alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + e))
                .finally(() => { btn.disabled = false; spinner.style.display = 'none'; });
            });
        }

        let modalCallback = null;
        function showModal(title, msg, callback, showCancel = true, isHtml = false) {
            document.getElementById('modalTitle').innerText = title;
            
            const msgEl = document.getElementById('modalMsg');
            if (isHtml) {
                msgEl.innerHTML = msg; 
            } else {
                msgEl.innerText = msg; 
            }
            
            document.getElementById('modalOverlay').style.display = 'flex';
            document.getElementById('modalCancelBtn').style.display = showCancel ? 'block' : 'none';
            modalCallback = callback;
        }

        function closeModal(result) {
            document.getElementById('modalOverlay').style.display = 'none';
            const cb = modalCallback; modalCallback = null;
            if (cb) cb(result);
        }

        function addLog() {
            const totalInput = document.getElementById('total').value;
            const simInput = document.getElementById('sim').value;
            const totalMins = timeToMins(totalInput);
            const simMins = timeToMins(simInput);

            if(totalMins === 0 && simMins === 0) {
                alert("ë¹„í–‰ ì‹œê°„(BLOCK) ë˜ëŠ” ì‹œë®¬ë ˆì´í„°(SIM) ì‹œê°„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }

            const b = calculateBreakdown(document.getElementById('code').value, totalMins);
            
            const newLog = { 
                id: Date.now(), 
                type: document.getElementById('type').value.toUpperCase() || "B789", 
                date: document.getElementById('date').value,
                reg: document.getElementById('reg').value.toUpperCase(), 
                fm: document.getElementById('fm').value, 
                to: document.getElementById('to').value,
                fltno: document.getElementById('fltno').value.toUpperCase(), 
                code: document.getElementById('code').value,
                total: minsToTime(totalMins), 
                ip: minsToTime(b.ip), 
                capt: minsToTime(b.capt), 
                fo: minsToTime(b.fo),
                sim: minsToTime(simMins), 
                dto: document.getElementById('dto').value, 
                nto: document.getElementById('nto').value, 
                dld: document.getElementById('dld').value, 
                nld: document.getElementById('nld').value, 
                remark: document.getElementById('remark').value
            };

            logs.push(newLog); 
            saveData(); 
            render(); 
            resetForm();
        }

        function editLog(id) {
            showModal("ìˆ˜ì • ëª¨ë“œ", "ì„ íƒí•œ ë¡œê·¸ë¥¼ ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?", (ok) => {
                if (!ok) return;
                const log = logs.find(l => String(l.id) === String(id)); 
                if(!log) { alert("ë¡œê·¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }

                setValueSafe('date', log.date);
                setValueSafe('type', log.type);
                setValueSafe('reg', log.reg);
                setValueSafe('fltno', log.fltno);
                setValueSafe('fm', log.fm);
                setValueSafe('to', log.to);
                setValueSafe('code', log.code);
                setValueSafe('total', log.total);
                setValueSafe('sim', log.sim);
                
                setValueSafe('dto', log.dto);
                setValueSafe('nto', log.nto);
                setValueSafe('dld', log.dld);
                setValueSafe('nld', log.nld);
                
                let tStr = log.dto == '1' ? 'Day' : (log.nto == '1' ? 'Night' : 'No');
                let lStr = log.dld == '1' ? 'Day' : (log.nld == '1' ? 'Night' : 'No');
                setValueSafe('toldDisplay', `${tStr} / ${lStr}`);
                
                setValueSafe('remark', log.remark);
                
                document.getElementById('editId').value = log.id;
                document.getElementById('btnAdd').style.display = 'none'; 
                document.getElementById('btnUpdate').style.display = 'inline-block';
                document.getElementById('btnCancel').style.display = 'inline-block';

                document.querySelector('.input-section').style.backgroundColor = '#fff3cd';
                window.scrollTo(0, 0);
                const activeTab = document.querySelector('.content-section.active');
                if(activeTab) activeTab.scrollTo(0, 0);
            });
        }

        function updateLog() {
            const id = document.getElementById('editId').value;
            const idx = logs.findIndex(l => String(l.id) === String(id));
            if(idx !== -1) {
                const tM = timeToMins(document.getElementById('total').value);
                const b = calculateBreakdown(document.getElementById('code').value, tM);
                logs[idx] = { 
                    ...logs[idx], 
                    type: document.getElementById('type').value.toUpperCase(), 
                    date: document.getElementById('date').value,
                    reg: document.getElementById('reg').value.toUpperCase(), 
                    fm: document.getElementById('fm').value, 
                    to: document.getElementById('to').value,
                    fltno: document.getElementById('fltno').value.toUpperCase(), 
                    code: document.getElementById('code').value,
                    total: minsToTime(tM), ip: minsToTime(b.ip), capt: minsToTime(b.capt), fo: minsToTime(b.fo),
                    sim: minsToTime(timeToMins(document.getElementById('sim').value)), 
                    dto: document.getElementById('dto').value, nto: document.getElementById('nto').value, 
                    dld: document.getElementById('dld').value, nld: document.getElementById('nld').value, 
                    remark: document.getElementById('remark').value
                };
                saveData(); render(); resetForm();
                alert("ìˆ˜ì • ì™„ë£Œ");
            }
        }

        function deleteLog(id) { 
            showModal("ì‚­ì œ í™•ì¸", "ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?", (ok) => {
                if (ok) { 
                    logs = logs.filter(l => String(l.id) !== String(id)); 
                    saveData(); render();
                }
            });
        }

        function resetForm() {
            ['editId','type','fltno','total','sim','remark','fm','to','reg','code'].forEach(id => setValueSafe(id, ''));
            setValueSafe('dto', '0'); setValueSafe('nto', '0'); setValueSafe('dld', '0'); setValueSafe('nld', '0');
            setValueSafe('toldDisplay', '');
            
            document.getElementById('btnAdd').style.display = 'inline-block'; 
            document.getElementById('btnUpdate').style.display = 'none';
            document.getElementById('btnCancel').style.display = 'none';
            document.getElementById('date').valueAsDate = new Date();
            document.querySelector('.input-section').style.backgroundColor = 'var(--white)';
        }

        function deleteRoute(flt) {
            showModal("ë…¸ì„  ì‚­ì œ", `[${flt}] ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, (ok) => {
                if(ok) { routes = routes.filter(r => r.fltno !== flt); localStorage.setItem(ROUTE_KEY, JSON.stringify(routes)); renderRouteTable(); }
            });
        }
        function saveRouteData() {
            const flt = document.getElementById('newDataFlt').value.toUpperCase().trim();
            const fm = document.getElementById('newDataFm').value.toUpperCase().trim();
            const to = document.getElementById('newDataTo').value.toUpperCase().trim();
            if (!flt || !fm || !to) { alert("ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”."); return; }
            const idx = routes.findIndex(r => r.fltno === flt);
            if(idx > -1) routes[idx] = { fltno: flt, fm, to }; else routes.push({ fltno: flt, fm, to });
            localStorage.setItem(ROUTE_KEY, JSON.stringify(routes));
            document.getElementById('newDataFlt').value = ''; document.getElementById('newDataFm').value = ''; document.getElementById('newDataTo').value = '';
            renderRouteTable();
        }
        function deleteCode(n) { 
            showModal("ì½”ë“œ ì‚­ì œ", `[${n}] ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, (ok) => {
                if(ok) { codeRules = codeRules.filter(c=>c.name!==n); localStorage.setItem(CODE_KEY, JSON.stringify(codeRules)); renderCodeTable(); }
            });
        }
        function saveCodeData() {
            const name = document.getElementById('newCodeName').value.toUpperCase().trim();
            const ip = parseFloat(document.getElementById('rateIP').value)||0, capt = parseFloat(document.getElementById('rateCapt').value)||0, fo = parseFloat(document.getElementById('rateFO').value)||0;
            if(!name) { alert("ì½”ë“œëª… ì…ë ¥"); return; }
            const idx = codeRules.findIndex(c => c.name === name);
            if(idx > -1) codeRules[idx] = {name, ip, capt, fo}; else codeRules.push({name, ip, capt, fo});
            localStorage.setItem(CODE_KEY, JSON.stringify(codeRules));
            renderCodeTable(); document.getElementById('newCodeName').value = '';
        }

        function setValueSafe(id, val) { const el = document.getElementById(id); if(el) el.value = (val === undefined || val === null) ? '' : val; }
        function normalizeType(t) { if(!t) return "ETC"; const u = t.toUpperCase().trim(); if(u.startsWith("B73")) return "B737"; if(u.startsWith("B77")) return "B777"; if(u.startsWith("B78")) return "B787"; return u; }
        function getCompany(f) { if(!f || f.length<2) return "ETC"; const p = f.substring(0,2).toUpperCase(); return ["KE","HU","YP"].includes(p)?p:"ETC"; }
        function timeToMins(t) { if(!t||t==="00+00") return 0; const c=String(t).replace(/\D/g,'').padStart(4,'0').slice(-4); return (parseInt(c.slice(0,2))||0)*60+(parseInt(c.slice(2,4))||0); }
        function minsToTime(m) { if (m === undefined || m === null) return ""; const hh = Math.floor(m / 60); const mm = (m % 60).toString().padStart(2, '0'); return `${hh}+${mm}`;}
        
        function calculateBreakdown(c, t) { const r=codeRules.find(x=>x.name===c); if(!r) return {ip:0,capt:0,fo:0}; return {ip:Math.floor(t*r.ip), capt:Math.floor(t*r.capt), fo:Math.floor(t*r.fo)}; }
        function saveData() { localStorage.setItem(STORAGE_KEY, JSON.stringify(logs)); }

        let isLimitView = true;
        function toggleViewAll() {
            isLimitView = !isLimitView;
            render();
        }

        function render() {
            const body = document.getElementById('logBody');
            body.innerHTML = '';
            
            logs.sort((a, b) => {
                const dateDiff = new Date(b.date) - new Date(a.date);
                if (dateDiff !== 0) return dateDiff;
                const fltA = a.fltno || "";
                const fltB = b.fltno || "";
                return fltB.localeCompare(fltA, undefined, { numeric: true });
            });

            const sDate = document.getElementById('startDateFilter').value,
                  eDate = document.getElementById('endDateFilter').value;
            const selType = document.getElementById('typeFilter').value || "ALL",
                  selComp = document.getElementById('companyFilter').value || "ALL";
            const selFrom = document.getElementById('fromFilter').value || "ALL",
                  selTo = document.getElementById('toFilter').value || "ALL";
            
            const now = new Date();
            const d28 = new Date(); d28.setDate(now.getDate() - 28);
            const d90 = new Date(); d90.setDate(now.getDate() - 90);
            const d365 = new Date(); d365.setDate(now.getDate() - 365);
            
            const cutoffDate = new Date();
            cutoffDate.setMonth(cutoffDate.getMonth() - 3);
            const yyyy = cutoffDate.getFullYear();
            const mm = String(cutoffDate.getMonth() + 1).padStart(2, '0');
            const dd = String(cutoffDate.getDate()).padStart(2, '0');
            const cutoffDateStr = `${yyyy}-${mm}-${dd}`;
            let hiddenRowCount = 0;
            
            let m28 = 0, m90 = 0, m365 = 0, tMins = 0,
                ipMTotal = 0, cpMTotal = 0, foMTotal = 0, simMTotal = 0,
                tDto = 0, tDld = 0, tNto = 0, tNld = 0, fCnt = 0;
            let toDates = [], ldDates = [];

            const getCls = (v) => (v === "00+00" || v === 0 || v === "0" || v === "0+00") ? 'class="val-zero"' : 'class="val-active"';

            logs.forEach(l => {
                const logDate = new Date(l.date),
                      curM = timeToMins(l.total);
                
                if (logDate >= d28 && logDate <= now) m28 += curM;
                if (logDate >= d90 && logDate <= now) m90 += curM;
                if (logDate >= d365 && logDate <= now) m365 += curM;

                if ((!sDate || l.date >= sDate) && (!eDate || l.date <= eDate) &&
                    (selType === "ALL" || normalizeType(l.type) === selType) &&
                    (selComp === "ALL" || getCompany(l.fltno) === selComp) &&
                    (selFrom === "ALL" || (l.fm || "") === selFrom) &&
                    (selTo === "ALL" || (l.to || "") === selTo)) {

                    const dto = parseInt(l.dto) || 0, dld = parseInt(l.dld) || 0;
                    const nto = parseInt(l.nto) || 0, nld = parseInt(l.nld) || 0;

                    if (!isLimitView || l.date >= cutoffDateStr) {
                        const row = body.insertRow();
                        row.innerHTML = `
                            <td>${l.date}</td>
                            <td>${l.type}</td>
                            <td>${l.reg.toUpperCase()}</td>
                            
                            <td class="text-bold">${l.fm||''}</td>
                            <td class="text-bold">${l.to||''}</td>
                            <td class="text-bold">${l.fltno.toUpperCase()}</td>
                            
                            <td class="row-total">${minsToTime(timeToMins(l.total))}</td>
                            <td ${getCls(l.ip)}>${minsToTime(timeToMins(l.ip))}</td>
                            <td ${getCls(l.capt)}>${minsToTime(timeToMins(l.capt))}</td>
                            <td ${getCls(l.fo)}>${minsToTime(timeToMins(l.fo))}</td>
                            <td ${getCls(l.sim)}>${minsToTime(timeToMins(l.sim))}</td>
                            <td ${getCls(dto + dld)}>${dto}/${dld}</td>
                            <td ${getCls(nto + nld)}>${nto}/${nld}</td>
                            <td>${l.remark}</td>
                            <td>
                                <button class="btn-edit" onclick="editLog('${l.id}')">âœ</button>
                                <button class="btn-del" onclick="deleteLog('${l.id}')">Ã—</button>
                            </td>
                        `;
                    } else {
                        hiddenRowCount++;
                    }

                    tMins += curM;
                    ipMTotal += timeToMins(l.ip);
                    cpMTotal += timeToMins(l.capt);
                    foMTotal += timeToMins(l.fo);
                    simMTotal += timeToMins(l.sim);
                    tDto += dto; tDld += dld; tNto += nto; tNld += nld;
                    fCnt++;

                    if (timeToMins(l.sim) > 0) {
                        for (let k = 0; k < 3; k++) { toDates.push(l.date); ldDates.push(l.date); }
                    } else {
                        if ((dto + nto) > 0) toDates.push(l.date);
                        if ((dld + nld) > 0) ldDates.push(l.date);
                    }
                }
            });

            const floatBtn = document.getElementById('floatingViewBtn');
            if (floatBtn) {
                if (isLimitView && hiddenRowCount > 0) {
                    floatBtn.style.display = 'block';
                    floatBtn.innerHTML = `<button onclick="toggleViewAll()">ê³¼ê±° ê¸°ë¡ ${hiddenRowCount}ê°œ ë” ë³´ê¸° â¬‡ï¸</button>`;
                } else if (!isLimitView && hiddenRowCount === 0 && logs.length > 0) {
                    floatBtn.style.display = 'block';
                    floatBtn.innerHTML = `<button onclick="toggleViewAll()" style="background:#666;">ìµœê·¼ 3ê°œì›”ë§Œ ë³´ê¸° â¬†ï¸</button>`;
                } else {
                    floatBtn.style.display = 'none';
                }
            }


            toDates.sort((a, b) => new Date(b) - new Date(a));
            ldDates.sort((a, b) => new Date(b) - new Date(a));
            const thirdTO = toDates[2] || null, thirdLD = ldDates[2] || null;

            document.getElementById('dash28').innerText = minsToTime(m28);
            document.getElementById('dash90').innerText = minsToTime(m90);
            document.getElementById('dash365').innerText = minsToTime(m365);

            const addDays = (ds, d) => { if (!ds) return null; let dt = new Date(ds); dt.setDate(dt.getDate() + d); return dt; };
            const formatYMD = (dt) => dt ? dt.toISOString().split('T')[0] : "-";
            const applyRecencyColor = (cid, tid, date) => {
                const c = document.getElementById(cid), t = document.getElementById(tid);
                if (!date) { c.style.borderTopColor = 'var(--ap-navy)'; t.style.color = 'var(--ap-navy)'; t.innerText = "-"; return; }
                const diff = (date - now) / (1000 * 60 * 60 * 24);
                if (diff <= 15) { c.style.borderTopColor = 'var(--danger)'; t.style.color = 'var(--danger)'; }
                else { c.style.borderTopColor = 'var(--ap-navy)'; t.style.color = 'var(--ap-navy)'; }
                t.innerText = formatYMD(date);
            };

            applyRecencyColor('cardRecTO', 'dashRecTO', addDays(thirdTO, 90));
            applyRecencyColor('cardRecLD', 'dashRecLD', addDays(thirdLD, 90));

            document.getElementById('statTime').innerText = minsToTime(tMins);
            document.getElementById('statPIC').innerText = minsToTime(ipMTotal + cpMTotal);
            document.getElementById('statIPSub').innerText = `(IP: ${minsToTime(ipMTotal)})`;
            document.getElementById('statFO').innerText = minsToTime(foMTotal);
            document.getElementById('statSimTotal').innerText = minsToTime(simMTotal);
            document.getElementById('statFlt').innerText = fCnt;
            document.getElementById('statToLdCombined').innerHTML = `${tDto + tNto}(${tNto}) <br> ${tDld + tNld}(${tNld})`;
        }

        function showTab(tabId, btn) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            btn.classList.add('active');
        }

        function openStatsFilterModal() {
            document.getElementById('statsFilterModalOverlay').style.display = 'flex';
        }

        function closeStatsFilterModal() {
            document.getElementById('statsFilterModalOverlay').style.display = 'none';
        }

        function applyStatsFilters() {
            render();
            closeStatsFilterModal();
        }

        function resetStatsFilters() {
            setValueSafe('startDateFilter',''); 
            setValueSafe('endDateFilter',''); 
            setValueSafe('typeFilter','ALL'); 
            setValueSafe('companyFilter','ALL'); 
            setValueSafe('fromFilter','ALL'); 
            setValueSafe('toFilter','ALL'); 
            render();
            closeStatsFilterModal();
        }

        function autoFillRoute() {
            const r = routes.find(x => x.fltno === document.getElementById('fltno').value);
            if(r) { setValueSafe('fm', r.fm); setValueSafe('to', r.to); } else { setValueSafe('fm', ''); setValueSafe('to', ''); }
        }
        
        function renderRouteTable() { const b=document.getElementById('routeDataBody'); b.innerHTML=''; routes.sort((a,z)=>a.fltno.localeCompare(z.fltno)); routes.forEach(r=>{ b.insertRow().innerHTML=`<td>${r.fltno}</td><td>${r.fm}</td><td>${r.to}</td><td><button class="btn-del" onclick="deleteRoute('${r.fltno}')">Ã—</button></td>`; }); }
        function renderCodeTable() { const b=document.getElementById('codeDataBody'); b.innerHTML=''; codeRules.sort((a,z)=>a.name.localeCompare(z.name)); codeRules.forEach(c=>{ b.insertRow().innerHTML=`<td>${c.name}</td><td>${c.ip}</td><td>${c.capt}</td><td>${c.fo}</td><td><button class="btn-del" onclick="deleteCode('${c.name}')">Ã—</button></td>`; }); }
        function handleRegChange() { if(document.getElementById('reg').value==="SIM"){ setValueSafe('type','B789'); setValueSafe('fltno','YP'); setValueSafe('fm',''); setValueSafe('to',''); setValueSafe('code',''); setValueSafe('total',''); setValueSafe('dto','0'); setValueSafe('nto','0'); setValueSafe('dld','0'); setValueSafe('nld','0'); setValueSafe('toldDisplay','No / No'); } }

        function exportCSV() {
            let csv = "\ufeffDate,TYPE,REG,FM,TO,FLT NO,Code,Block,IP,Captain,FO,SIM,DayTO,DayLD,NtTO,NtLD,Remarks\n";
            
            const safeStr = (s) => {
                const str = String(s || "").replace(/"/g, '""'); 
                return /[",\n]/.test(str) ? `"${str}"` : str;
            };

            logs.forEach(l => {
                csv += `${safeStr(l.date)},${safeStr(l.type)},${safeStr(l.reg)},${safeStr(l.fm)},${safeStr(l.to)},${safeStr(l.fltno)},${safeStr(l.code)},${safeStr(l.total)},${safeStr(l.ip)},${safeStr(l.capt)},${safeStr(l.fo)},${safeStr(l.sim)},${l.dto},${l.dld},${l.nto},${l.nld},${safeStr(l.remark)}\n`;
            });
            
            const link = document.createElement("a");
            link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' }));
            link.download = `Pilot_Logbook_${new Date().toISOString().slice(0, 10)}.csv`;
            link.click();
        }
        function importCSV(i) {
            const r = new FileReader();
            r.onload = function(e) {
                const rows = e.target.result.split('\n').filter(r => r.trim() !== "");
                if (rows.length < 2) return;
                const newLogs = [];
                
                const parseCSVLine = (str) => {
                    const arr = [];
                    let quote = false;
                    let col = "";
                    for (let c of str) {
                        if (c === '"') { quote = !quote; continue; }
                        if (c === ',' && !quote) { arr.push(col.trim()); col = ""; }
                        else { col += c; }
                    }
                    arr.push(col.trim());
                    return arr;
                };
                
                for (let k = 1; k < rows.length; k++) {
                    const c = parseCSVLine(rows[k]);
                    if (c.length < 10) continue; 

                    newLogs.push({
                        id: Date.now() + k,
                        date: c[0],
                        type: c[1] || 'B789',
                        reg: c[2] || '',
                        fm: c[3] || '',
                        to: c[4] || '',
                        fltno: c[5] || '',
                        code: c[6] || '',          
                        total: c[7] || '00+00',    
                        ip: c[8] || '00+00',       
                        capt: c[9] || '00+00',     
                        fo: c[10] || '00+00',      
                        sim: c[11] || '00+00',     
                        dto: c[12] || 0,           
                        dld: c[13] || 0,           
                        nto: c[14] || 0,           
                        nld: c[15] || 0,           
                        remark: c[16] || ""        
                    });
                }
                
                if (newLogs.length > 0) {
                    showModal("ë³µêµ¬ í™•ì¸", `${newLogs.length}ê°œì˜ ë°ì´í„°ë¥¼ ë³µêµ¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, (ok) => {
                        if (ok) {
                            logs = [...newLogs, ...logs];
                            saveData();
                            render();
                        }
                    });
                }
            };
            r.readAsText(i.files[0], "UTF-8");
            i.value = '';
        }
        function resetAllData() { showModal("ì „ì²´ ì´ˆê¸°í™”", "ëª¨ë“  ê¸°ë¡ì´ ì‚­ì œë©ë‹ˆë‹¤.", (ok)=>{if(ok){localStorage.clear();location.reload();}}); }

        let activeTimeInput = null;

        function initDialPicker() {
            const mw = document.getElementById('dialMinute');
            let mHtml = '<div class="dial-spacer"></div>';
            for(let i=0; i<=59; i++) mHtml += `<div class="dial-item">${i.toString().padStart(2,'0')}</div>`;
            mHtml += '<div class="dial-spacer"></div>';
            mw.innerHTML = mHtml;
        }

        function openTimeModal(inputElement) {
            activeTimeInput = inputElement;
            
            let maxHours = 20; 
            let titleText = "ë¹„í–‰ ì‹œê°„ ì…ë ¥";
            
            if (inputElement.id === 'sim') {
                maxHours = 6;
                titleText = "SIM ì‹œê°„ ì…ë ¥";
            }
            
            document.getElementById('timeModalHeader').innerText = titleText;

            const hw = document.getElementById('dialHour');
            let hHtml = '<div class="dial-spacer"></div>';
            for(let i=0; i<=maxHours; i++) hHtml += `<div class="dial-item">${i}</div>`;
            hHtml += '<div class="dial-spacer"></div>';
            hw.innerHTML = hHtml;
            
            let val = inputElement.value || "0+00";
            let parts = val.split('+');
            let h = parseInt(parts[0]) || 0;
            let m = parseInt(parts[1]) || 0;
            
            if (h > maxHours) h = maxHours; 
            
            document.getElementById('timeModalOverlay').style.display = 'flex';
            
            setTimeout(() => {
                hw.scrollTop = h * 40;
                document.getElementById('dialMinute').scrollTop = m * 40;
            }, 10);
        }

        function closeTimeModal() {
            document.getElementById('timeModalOverlay').style.display = 'none';
            activeTimeInput = null;
        }

        function confirmTime() {
            if(!activeTimeInput) return;
            
            const hw = document.getElementById('dialHour');
            const mw = document.getElementById('dialMinute');
            
            let h = Math.round(hw.scrollTop / 40);
            let m = Math.round(mw.scrollTop / 40);
            
            activeTimeInput.value = `${h}+${m.toString().padStart(2, '0')}`;
            closeTimeModal();
        }

        let currentDialTarget = '';
        let currentDialItems = [];
        let scrollTimeout = null;

        function openDial(target) {
            currentDialTarget = target;
            const mw = document.getElementById('genericDialWheel');
            const info = document.getElementById('genericDialInfo');
            info.innerText = '';
            
            let items = [];
            let headerText = '';
            
            if (target === 'reg') {
                headerText = 'REG ì„ íƒ';
                items = ['SIM', 'HL8387', 'HL8388', 'HL8389', 'HL8516', 'HL8517', 'HL8701', 'HL8702', 'HL8703', 'HL8704'];
            } else if (target === 'fltno') {
                headerText = 'FLT NO ì„ íƒ';
                items = [...routes].sort((a,b)=>a.fltno.localeCompare(b.fltno)).map(r => r.fltno);
            } else if (target === 'code') {
                headerText = 'Code ì„ íƒ';
                items = [...codeRules].sort((a,b)=>a.name.localeCompare(b.name)).map(c => c.name);
            } else if (target === 'typeFilter') {
                headerText = 'TYPE í•„í„°';
                items = ['ALL', ...Array.from(new Set(logs.map(l=>normalizeType(l.type)))).filter(s=>s).sort()];
            } else if (target === 'companyFilter') {
                headerText = 'í•­ê³µì‚¬ í•„í„°';
                items = ['ALL', 'KE', 'HU', 'YP', 'ETC'];
            } else if (target === 'fromFilter') {
                headerText = 'ì¶œë°œì§€(FM) í•„í„°';
                items = ['ALL', ...Array.from(new Set(logs.map(l=>l.fm))).filter(s=>s).sort()];
            } else if (target === 'toFilter') {
                headerText = 'ë„ì°©ì§€(TO) í•„í„°';
                items = ['ALL', ...Array.from(new Set(logs.map(l=>l.to))).filter(s=>s).sort()];
            }
            
            if (!['typeFilter', 'companyFilter', 'fromFilter', 'toFilter'].includes(target)) {
                items.unshift(''); 
            }
            
            currentDialItems = items;
            document.getElementById('genericDialHeader').innerText = headerText;
            
            let html = '<div class="dial-spacer"></div>';
            items.forEach((item, idx) => {
                html += `<div class="dial-item" data-idx="${idx}">${item === '' ? '(ì„ íƒ ì•ˆí•¨)' : item}</div>`;
            });
            html += '<div class="dial-spacer"></div>';
            mw.innerHTML = html;
            
            const currentVal = document.getElementById(target).value;
            let targetIdx = items.indexOf(currentVal);
            if (targetIdx === -1) targetIdx = 0;
            
            document.getElementById('genericDialModalOverlay').style.display = 'flex';
            
            setTimeout(() => {
                mw.scrollTop = targetIdx * 40;
                handleGenericDialScroll(); 
            }, 10);
        }

        function handleGenericDialScroll() {
            if (currentDialTarget !== 'fltno') return; 
            
            clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(() => {
                const mw = document.getElementById('genericDialWheel');
                let idx = Math.round(mw.scrollTop / 40);
                if (idx < 0) idx = 0;
                if (idx >= currentDialItems.length) idx = currentDialItems.length - 1;
                
                const selectedFlt = currentDialItems[idx];
                const info = document.getElementById('genericDialInfo');
                
                if (!selectedFlt) {
                    info.innerText = 'ë¹„í–‰í¸ì„ ì„ íƒí•˜ì„¸ìš”';
                } else {
                    const r = routes.find(x => x.fltno === selectedFlt);
                    if (r) {
                        info.innerText = `${r.fm} â” ${r.to}`;
                    } else {
                        info.innerText = '';
                    }
                }
            }, 100); 
        }

        function closeGenericDial() {
            document.getElementById('genericDialModalOverlay').style.display = 'none';
        }

        function confirmGenericDial() {
            const mw = document.getElementById('genericDialWheel');
            let idx = Math.round(mw.scrollTop / 40);
            if (idx < 0) idx = 0;
            if (idx >= currentDialItems.length) idx = currentDialItems.length - 1;
            
            const selectedVal = currentDialItems[idx];
            document.getElementById(currentDialTarget).value = selectedVal;
            
            if (currentDialTarget === 'reg') {
                handleRegChange();
            } else if (currentDialTarget === 'fltno') {
                autoFillRoute();
            }
            
            closeGenericDial();
        }

        const toldOptions = [
            { label: 'No', val: 'No' },
            { label: 'PF(Day)', val: 'DAY' },
            { label: 'PF(Night)', val: 'NIGHT' }
        ];

        function openToldModal() {
            const hw = document.getElementById('dialTkof');
            const mw = document.getElementById('dialLand');
            
            let html = '<div class="dial-spacer"></div>';
            toldOptions.forEach((opt, idx) => {
                html += `<div class="dial-item" style="font-size:1.0rem;" data-val="${opt.val}">${opt.label}</div>`;
            });
            html += '<div class="dial-spacer"></div>';
            
            hw.innerHTML = html;
            mw.innerHTML = html;
            
            const dto = document.getElementById('dto').value;
            const nto = document.getElementById('nto').value;
            const dld = document.getElementById('dld').value;
            const nld = document.getElementById('nld').value;
            
            let tIdx = 0; 
            if (dto === '1') tIdx = 1;
            if (nto === '1') tIdx = 2;
            
            let lIdx = 0; 
            if (dld === '1') lIdx = 1;
            if (nld === '1') lIdx = 2;
            
            document.getElementById('toldModalOverlay').style.display = 'flex';
            
            setTimeout(() => {
                hw.scrollTop = tIdx * 40;
                mw.scrollTop = lIdx * 40;
            }, 10);
        }

        function closeToldModal() {
            document.getElementById('toldModalOverlay').style.display = 'none';
        }

        function confirmToldDial() {
            const hw = document.getElementById('dialTkof');
            const mw = document.getElementById('dialLand');
            
            let tIdx = Math.round(hw.scrollTop / 40);
            let lIdx = Math.round(mw.scrollTop / 40);
            
            const tVal = toldOptions[tIdx]?.val || 'No';
            const lVal = toldOptions[lIdx]?.val || 'No';
            
            document.getElementById('dto').value = '0';
            document.getElementById('nto').value = '0';
            document.getElementById('dld').value = '0';
            document.getElementById('nld').value = '0';
            
            let tStr = 'No';
            if (tVal === 'DAY') { document.getElementById('dto').value = '1'; tStr = 'Day'; }
            if (tVal === 'NIGHT') { document.getElementById('nto').value = '1'; tStr = 'Night'; }
            
            let lStr = 'No';
            if (lVal === 'DAY') { document.getElementById('dld').value = '1'; lStr = 'Day'; }
            if (lVal === 'NIGHT') { document.getElementById('nld').value = '1'; lStr = 'Night'; }
            
            document.getElementById('toldDisplay').value = `${tStr} / ${lStr}`;
            
            closeToldModal();
        }

        window.onload = init;
    </script>
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('sw.js')
            .then(registration => {
              console.log('Logbook ServiceWorker ë“±ë¡ ì„±ê³µ:', registration.scope);
            })
            .catch(error => {
              console.log('Logbook ServiceWorker ë“±ë¡ ì‹¤íŒ¨:', error);
            });
        });
      }
    </script>
</body>
</html>